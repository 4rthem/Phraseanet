{% macro block(record, highlight, searchEngine, prefix, entry_id)%}
    {% import 'common/thumbnail.html.twig' as thumbnail_macro %}
    {% import 'common/doctype_icons.html.twig' as doctype_icons %}
    {% import 'common/drop_down_options.html.twig' as drop_down %}
    {% set th_size = app['settings'].getUserSetting(app['authentication'].user, 'images_size')%}

    {% if entry_id %}
        <div style="width:{{th_size+30}}px;" sbas="{{record.databoxId}}"
            id="{{ prefix|default('IMGT') }}_{{record.id}}"
            class="IMGT diapo type-{{record.type}}"
            onDblClick="openPreview('FEED',{{record.position}},{{entry_id}});">
    {% elseif record.story %}
        <div style="width:{{th_size+30}}px;" sbas="{{record.databoxId}}"
            id="{{ prefix|default('IMGT') }}_{{record.id}}"
            class="IMGT diapo grouping type-{{record.type}}"
            onDblClick="openPreview('REG','0','{{record.id}}');">
    {% else %}
        <div style="width:{{th_size+30}}px;" sbas="{{record.databoxId}}"
            id="{{ prefix|default('IMGT') }}_{{record.id}}"
            class="IMGT diapo type-{{record.type}}"
            onDblClick="openPreview('RESULT',{{record.position}});">
    {% endif %}
        <div style="padding: 4px;">
            <div style="height:40px; position: relative; z-index: 95;margin-bottom:0;border-bottom:none;">
                {# @todo title should be localized #}
                <div class="title" style="max-height:100%" title="{{ record.title }}">
                    {{ record.title }}
                </div>
                <div class="status">
                {# @todo find a proper way to map lifted flag to status icon img path #}
                {#{{record.get_status_icons|raw}}#}
                </div>
            </div>
            {% set thumbnail = record.subdefs.containsKey('thumbnail') ? record.subdefs.get('thumbnail') : null %}
            {% set preview = record.subdefs.containsKey('preview') ? record.subdefs.get('preview') : null %}
            {% set rollover_thumbnail = record.subdefs.containsKey('thumbnailgif') ? record.subdefs.get('thumbnailgif') : null %}

            {% set user_technical_display = app['settings'].getUserSetting(app['authentication'].user, 'technical_display') %}
            {% set user_rollover_thumbnail = app['settings'].getUserSetting(app['authentication'].user, 'rollover_thumbnail') %}

            {% set extraclass = '' %}
            {% if user_rollover_thumbnail == 'caption' and searchEngine is not null %}
                {% set extraclass = extraclass ~ ' captionTips' %}
                {% set tooltip = path('prod_tooltip_caption', { 'sbas_id' : record.databoxId, 'record_id' : record.recordId, 'context' : 'answer', 'number' : record.position }) %}
            {% elseif user_rollover_thumbnail == 'caption' and searchEngine is null %}
                {% set extraclass = extraclass ~ ' captionTips' %}
                {% set tooltip = path('prod_tooltip_caption', { 'sbas_id' : record.databoxId, 'record_id' : record.recordId, 'context' : 'publi' }) %}
            {% elseif user_rollover_thumbnail == 'preview' %}
                {% set extraclass = extraclass ~ ' captionTips' %}
                {% set tooltip = path('prod_tooltip_preview', { 'sbas_id' : record.databoxId, 'record_id' : record.recordId }) %}
            {% endif %}
            <div class="thumb {{extraclass}} " tooltipsrc="{{tooltip}}" style="height:{{th_size}}px; z-index:90;">
                <div class="doc_infos">
                {% if app['settings'].getUserSetting(app['authentication'].user, 'doctype_display') == '1' %}
                {{doctype_icons.format(record)}}
                {% endif %}
                <span class="duration">
                    {% if record.type == 'video' and attribute(record.exif, constant('\\media_subdef::TC_DATA_DURATION')) is defined %}
                        {{ attribute(record.exif, constant('\\media_subdef::TC_DATA_DURATION')) }}
                    {% endif %}
                </span>
                </div>
                <div class="{% if rollover_thumbnail %}rollovable{% endif %}">
                {% set extraclass = '' %}

                {% if thumbnail is not none and thumbnail.path is defined and (thumbnail.path is not empty or thumbnail.path is not none) %}
                    {% set path = thumbnail.path %}
                    {% set width = thumbnail.width %}
                    {% set height = thumbnail.height %}
                {% else %}
                    {% set path = app['root.path'] ~ '/www/skins/icons/substitution/' ~ record.mimeType|replace({'/': '_'}) ~ '.png' %}
                    {% set width = 256 %}
                    {% set height = 256 %}
                {% endif %}

                {% set url = app['phraseanet.static-file'].getUrl(path) %}

                {{thumbnail_macro.format(record, url, width, height, th_size, th_size, extraclass, true, true)}}

                {% if rollover_thumbnail %}
                    {% set extraclass = 'rollover-gif-out' %}
                    {% if rollover_thumbnail.path is defined and (rollover_thumbnail.path is not empty or rollover_thumbnail.path is not none) %}
                        {% set url = app['phraseanet.static-file'].getUrl(rollover_thumbnail.path) %}
                        {{thumbnail_macro.format(record, url, rollover_thumbnail.width, rollover_thumbnail.height, th_size, th_size, 'rollover-gif-hover', true, true)}}
                    {% endif %}
                {% endif %}
                </div>
            </div>
            <div style="height: 25px; position:relative; text-align:left;">
                <table class="bottom" style="width:100%; table-layout:fixed;">
                <tr>
                    <td style="text-align:left;text-overflow:ellipsis;overflow:hidden;">
                    {{record.baseId | get_collection_logo(app, true)|raw}}
                    </td>
                    {% set l_width = 30 %}
                    {% if user_rollover_thumbnail == 'preview' %}
                    {% set l_width = l_width + 20 %}
                    {% endif %}
                    {% if user_technical_display == '1' %}
                    {% set l_width = l_width + 20 %}
                    {% endif %}
                    <td style='text-align:right;width:{{l_width}}px;' valign='bottom'>
                    {{drop_down.prod(record, entry_id)}}
                    {% if preview and app['acl'].get(app['authentication'].user).has_access_to_subdef(record, 'preview') %}
                        <div tooltipsrc="{{ path('prod_tooltip_preview', { 'databoxId' : record.databoxId, 'recordId' : record.recordId }) }}" class="previewTips"></div>
                    {% endif %}
                    {% if user_rollover_thumbnail == 'preview' %}
                    <div tooltipsrc="{{ path('prod_tooltip_caption', { 'sbas_id' : record.databoxId, 'record_id' : record.recordId, 'context' : 'answer', 'number' : record.position }) }}" class="captionRolloverTips"></div>
                    {% endif %}
                    {% if user_technical_display == '1' %}
                    <img class="infoTips" tooltipsrc="{{ path('prod_tooltip_technical_data', { 'sbas_id' : record.databoxId, 'record_id' : record.recordId }) }}" src="/skins/icons/info.gif"/>
                    {% endif %}
                    </td>
                </tr>
                </table>
            </div>
        </div>
    </div>
{% endmacro %}
